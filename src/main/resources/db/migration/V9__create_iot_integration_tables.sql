-- =====================================================
-- EXTENSÃO IOT E INTEGRAÇÃO MULTI-DISCIPLINAR
-- Challenge 2025 - 4º Sprint
-- =====================================================

-- Tabela de Dispositivos IoT
CREATE TABLE T_MT_DISPOSITIVO_IOT (
    ID_DISPOSITIVO    VARCHAR2(50) PRIMARY KEY,
    NM_DISPOSITIVO    VARCHAR2(100) NOT NULL,
    TP_DISPOSITIVO    VARCHAR2(50) NOT NULL, -- sensor_movimento, camera, atuador_trava, etc
    ST_STATUS         VARCHAR2(20) DEFAULT 'ONLINE',
    DS_LOCALIZACAO    VARCHAR2(200),
    DT_ULTIMA_COM     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    TX_CONFIGURACAO   CLOB,
    CD_ZONA           VARCHAR2(10),
    NR_LATITUDE       NUMBER(10,7),
    NR_LONGITUDE      NUMBER(10,7),
    DT_CRIACAO        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DT_ATUALIZACAO    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de Sensores IoT (dados específicos)
CREATE TABLE T_MT_SENSOR_DADOS (
    ID_LEITURA        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_DISPOSITIVO    VARCHAR2(50) NOT NULL,
    TP_SENSOR         VARCHAR2(50) NOT NULL, -- movimento, temperatura, bateria, etc
    VL_LEITURA        NUMBER(15,4),
    TX_DADOS_JSON     CLOB,
    DT_LEITURA        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ST_PROCESSADO     CHAR(1) DEFAULT 'N',
    CONSTRAINT FK_SENSOR_DISPOSITIVO FOREIGN KEY (ID_DISPOSITIVO) REFERENCES T_MT_DISPOSITIVO_IOT (ID_DISPOSITIVO)
);

-- Tabela de Alertas do Sistema
CREATE TABLE T_MT_ALERTA (
    ID_ALERTA         VARCHAR2(50) PRIMARY KEY,
    TP_ALERTA         VARCHAR2(50) NOT NULL, -- iot, sistema, manutencao, seguranca
    NV_SEVERIDADE     VARCHAR2(20) DEFAULT 'INFO', -- LOW, MEDIUM, HIGH, CRITICAL
    TX_TITULO         VARCHAR2(200) NOT NULL,
    TX_DESCRICAO      CLOB,
    CD_PLACA_MOTO     VARCHAR2(10),
    ID_DISPOSITIVO    VARCHAR2(50),
    CD_ZONA           VARCHAR2(10),
    ST_ATIVO          CHAR(1) DEFAULT 'S',
    DT_CRIACAO        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DT_RESOLUCAO      TIMESTAMP,
    ID_RESOLVIDO_POR  NUMBER,
    TX_OBSERVACOES    CLOB,
    CONSTRAINT FK_ALERTA_MOTO FOREIGN KEY (CD_PLACA_MOTO) REFERENCES T_MT_MOTO (CD_PLACA),
    CONSTRAINT FK_ALERTA_DISPOSITIVO FOREIGN KEY (ID_DISPOSITIVO) REFERENCES T_MT_DISPOSITIVO_IOT (ID_DISPOSITIVO),
    CONSTRAINT FK_ALERTA_FUNCIONARIO FOREIGN KEY (ID_RESOLVIDO_POR) REFERENCES T_MT_FUNCIONARIO (ID_FUNCIONARIO)
);

-- Tabela de Histórico de Uso das Motos
CREATE TABLE T_MT_HISTORICO_USO (
    ID_HISTORICO      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CD_PLACA          VARCHAR2(10) NOT NULL,
    CD_CPF_USUARIO    VARCHAR2(20),
    DT_INICIO_USO     TIMESTAMP NOT NULL,
    DT_FIM_USO        TIMESTAMP,
    DS_LOC_INICIAL    VARCHAR2(200),
    DS_LOC_FINAL      VARCHAR2(200),
    NR_DISTANCIA_KM   NUMBER(10,2) DEFAULT 0,
    NR_TEMPO_USO_MIN  NUMBER(10) DEFAULT 0,
    ST_USO            VARCHAR2(20) DEFAULT 'EM_ANDAMENTO', -- EM_ANDAMENTO, FINALIZADO, CANCELADO
    TX_OBSERVACOES    VARCHAR2(500),
    CONSTRAINT FK_HISTORICO_MOTO FOREIGN KEY (CD_PLACA) REFERENCES T_MT_MOTO (CD_PLACA),
    CONSTRAINT FK_HISTORICO_USUARIO FOREIGN KEY (CD_CPF_USUARIO) REFERENCES T_MT_USUARIO (CD_CPF)
);

-- Tabela de Localização das Motos em Tempo Real
CREATE TABLE T_MT_LOCALIZACAO_MOTO (
    ID_LOCALIZACAO    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CD_PLACA          VARCHAR2(10) NOT NULL,
    NR_LATITUDE       NUMBER(10,7),
    NR_LONGITUDE      NUMBER(10,7),
    CD_ZONA           VARCHAR2(10),
    DS_ENDERECO       VARCHAR2(300),
    DS_SETOR          VARCHAR2(50),
    NR_ANDAR          NUMBER(3) DEFAULT 1,
    CD_VAGA           VARCHAR2(20),
    DS_DESCRICAO_LOC  VARCHAR2(500),
    ST_STATUS_MOTO    VARCHAR2(20) DEFAULT 'DISPONIVEL', -- DISPONIVEL, EM_USO, MANUTENCAO, RESERVADA
    NR_BATERIA        NUMBER(3) DEFAULT 100,
    DT_ULTIMA_ATU     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CD_CPF_EM_USO     VARCHAR2(20),
    CONSTRAINT FK_LOC_MOTO FOREIGN KEY (CD_PLACA) REFERENCES T_MT_MOTO (CD_PLACA),
    CONSTRAINT FK_LOC_USUARIO_USO FOREIGN KEY (CD_CPF_EM_USO) REFERENCES T_MT_USUARIO (CD_CPF),
    CONSTRAINT UK_PLACA_LOCALIZACAO UNIQUE (CD_PLACA)
);

-- Tabela de Eventos IoT (para idempotência)
CREATE TABLE T_MT_EVENTO_IOT (
    ID_EVENTO         VARCHAR2(100) PRIMARY KEY, -- Chave de idempotência
    ID_ALERTA         VARCHAR2(50) NOT NULL,
    ID_DISPOSITIVO    VARCHAR2(50),
    TP_EVENTO         VARCHAR2(50),
    TX_PAYLOAD        CLOB,
    DT_EVENTO         TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ST_PROCESSADO     CHAR(1) DEFAULT 'S',
    CONSTRAINT FK_EVENTO_ALERTA FOREIGN KEY (ID_ALERTA) REFERENCES T_MT_ALERTA (ID_ALERTA),
    CONSTRAINT FK_EVENTO_DISPOSITIVO FOREIGN KEY (ID_DISPOSITIVO) REFERENCES T_MT_DISPOSITIVO_IOT (ID_DISPOSITIVO)
);

-- Tabela de Tokens Push (Mobile)
CREATE TABLE T_MT_PUSH_TOKEN (
    ID_TOKEN          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TX_TOKEN          VARCHAR2(500) UNIQUE NOT NULL,
    CD_CPF_USUARIO    VARCHAR2(20),
    ID_FUNCIONARIO    NUMBER,
    DS_PLATAFORMA     VARCHAR2(20) DEFAULT 'ANDROID', -- ANDROID, IOS
    ST_ATIVO          CHAR(1) DEFAULT 'S',
    DT_CRIACAO        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DT_ULTIMO_ACESSO  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_PUSH_USUARIO FOREIGN KEY (CD_CPF_USUARIO) REFERENCES T_MT_USUARIO (CD_CPF),
    CONSTRAINT FK_PUSH_FUNCIONARIO FOREIGN KEY (ID_FUNCIONARIO) REFERENCES T_MT_FUNCIONARIO (ID_FUNCIONARIO)
);

-- Tabela de Auditoria Geral
CREATE TABLE T_MT_AUDITORIA (
    ID_AUDITORIA      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NM_TABELA         VARCHAR2(50) NOT NULL,
    ID_REGISTRO       VARCHAR2(50) NOT NULL,
    TP_OPERACAO       VARCHAR2(10) NOT NULL, -- INSERT, UPDATE, DELETE
    TX_DADOS_ANTES    CLOB,
    TX_DADOS_DEPOIS   CLOB,
    CD_CPF_USUARIO    VARCHAR2(20),
    ID_FUNCIONARIO    NUMBER,
    DT_OPERACAO       TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DS_IP_ORIGEM      VARCHAR2(50),
    DS_USER_AGENT     VARCHAR2(500),
    CONSTRAINT FK_AUD_USUARIO FOREIGN KEY (CD_CPF_USUARIO) REFERENCES T_MT_USUARIO (CD_CPF),
    CONSTRAINT FK_AUD_FUNCIONARIO FOREIGN KEY (ID_FUNCIONARIO) REFERENCES T_MT_FUNCIONARIO (ID_FUNCIONARIO)
);

-- Comentários nas tabelas
COMMENT ON TABLE T_MT_DISPOSITIVO_IOT IS 'Cadastro de dispositivos IoT do sistema';
COMMENT ON TABLE T_MT_SENSOR_DADOS IS 'Dados coletados pelos sensores IoT';
COMMENT ON TABLE T_MT_ALERTA IS 'Sistema de alertas integrado';
COMMENT ON TABLE T_MT_HISTORICO_USO IS 'Histórico de utilização das motocicletas';
COMMENT ON TABLE T_MT_LOCALIZACAO_MOTO IS 'Localização em tempo real das motos';
COMMENT ON TABLE T_MT_EVENTO_IOT IS 'Eventos IoT com controle de idempotência';
COMMENT ON TABLE T_MT_PUSH_TOKEN IS 'Tokens para notificações push mobile';
COMMENT ON TABLE T_MT_AUDITORIA IS 'Auditoria completa do sistema';
